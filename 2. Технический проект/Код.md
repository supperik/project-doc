## 1) Регистрация пользователя
```mermaid
sequenceDiagram
    actor User as Пользователь
    participant UI as Клиент (Web/Mobile)
    participant API as API Gateway
    participant Auth as Auth Service
    participant UDB as Users DB
    participant ES as Email Service
    participant Bus as Event Bus
    participant NS as Notification Service

    User->>UI: Заполнить форму регистрации
    UI->>API: POST /auth/register (email, password)
    API->>Auth: Register(cmd)
    Auth->>UDB: Проверка email + создание пользователя (status=PENDING)
    alt Email уже существует
        UDB-->>Auth: Conflict
        Auth-->>API: 409 EmailExists
        API-->>UI: Ошибка "email уже занят"
    else Успешно
        UDB-->>Auth: userId
        Auth->>ES: SendVerification(email, token)
        Auth->>Bus: Event UserRegistered(userId)
        Bus-->>NS: Deliver UserRegistered
        NS-->>UI: Push "Проверьте email"
        Auth-->>API: 201 Created
        API-->>UI: Регистрация успешна (ожидается подтверждение)
    end

    User->>UI: Перейти по ссылке из письма
    UI->>API: GET /auth/verify?token=...
    API->>Auth: VerifyEmail(token)
    Auth->>UDB: Update user status=ACTIVE
    UDB-->>Auth: OK
    Auth->>Bus: Event EmailVerified(userId)
    Auth-->>API: 200 OK
    API-->>UI: Email подтверждён, можно войти
```

## 2) Просмотр котировок в реальном времени
```mermaid
sequenceDiagram
    actor Trader as Трейдер
    participant UI as Клиент (Web/Mobile)
    participant API as API Gateway
    participant Auth as Auth Service
    participant MDS as Market Data Service
    participant Provider as External Market Data Provider
    participant Bus as Event Bus (Kafka/AMQP)
    participant WS as WebSocket Gateway

    Trader->>UI: Открыть инструмент (например, AAPL)
    UI->>API: GET /quotes/subscribe?symbol=AAPL
    API->>Auth: Проверка JWT/сессии
    Auth-->>API: OK
    API->>MDS: Subscribe(symbol=AAPL, userId)
    MDS->>Provider: Подписка на рыночные данные (AAPL)
    Provider-->>MDS: Поток котировок

    loop Каждая новая котировка
        MDS->>Bus: Event QuoteUpdated(symbol, price, ts)
        Bus-->>WS: Deliver QuoteUpdated
        WS-->>UI: Push котировки (WebSocket)
        UI-->>Trader: Обновление графика/стакана
    end

```

## 3) Создание ордера и исполнение у брокера
```mermaid
sequenceDiagram
    actor Trader as Трейдер
    participant UI as Клиент (Web/Mobile)
    participant API as API Gateway
    participant Auth as Auth Service
    participant OS as Order Service (Core)
    participant ODB as Orders DB
    participant Bus as Event Bus (Kafka/AMQP)
    participant BG as Broker Gateway
    participant Broker as External Broker/Exchange
    participant PS as Portfolio Service (Read/Update)
    participant PDB as Portfolio/Trades DB
    participant NS as Notification Service

    Trader->>UI: Создать ордер (BUY 10 AAPL, Market)
    UI->>API: POST /orders
    API->>Auth: Проверка прав/рисков (роль, 2FA)
    Auth-->>API: OK
    API->>OS: PlaceOrder(cmd)

    OS->>ODB: Persist Order(status=NEW)
    ODB-->>OS: OK
    OS->>Bus: Event OrderPlaced(orderId)

    Bus-->>BG: Consume OrderPlaced
    BG->>Broker: SubmitOrder(order)
    Broker-->>BG: ExecutionReport(ACK/FILL/REJECT)
    BG->>Bus: Event OrderExecutionReported(orderId, status, fills)

    Bus-->>OS: Consume OrderExecutionReported
    alt Ордер исполнен (FILL/PARTIAL)
        OS->>ODB: Update Order(status=FILLED/PARTIAL)
        OS->>Bus: Event OrderExecuted(orderId, fills)
        Bus-->>PS: Consume OrderExecuted
        PS->>PDB: Update positions + append trade
        PDB-->>PS: OK
        PS-->>Bus: Event PortfolioUpdated(userId)
        Bus-->>NS: Consume OrderExecuted
        NS-->>UI: Push уведомление (in-app/push/email)
        UI-->>Trader: Показать статус/сделку
    else Ордер отклонён (REJECT)
        OS->>ODB: Update Order(status=REJECTED, reason)
        OS->>Bus: Event OrderRejected(orderId, reason)
        Bus-->>NS: Consume OrderRejected
        NS-->>UI: Push уведомление об отказе
        UI-->>Trader: Показать причину отказа
    end

```

## 4) Просмотр портфеля и истории сделок
```mermaid
sequenceDiagram
    actor Trader as Трейдер
    participant UI as Клиент (Web/Mobile)
    participant API as API Gateway
    participant Auth as Auth Service
    participant PQ as Portfolio Query API
    participant RDB as Read DB (Portfolio + Trades)

    Trader->>UI: Открыть "Портфель"
    UI->>API: GET /portfolio
    API->>Auth: Проверка JWT/сессии
    Auth-->>API: OK
    API->>PQ: GetPortfolio(userId)
    PQ->>RDB: SELECT positions, PnL, cash
    RDB-->>PQ: Портфель
    PQ-->>API: PortfolioDTO
    API-->>UI: 200 OK + PortfolioDTO

    Trader->>UI: Открыть "История сделок"
    UI->>API: GET /trades?from=...&to=...
    API->>Auth: OK?
    Auth-->>API: OK
    API->>PQ: GetTrades(userId, range)
    PQ->>RDB: SELECT trades WHERE userId AND range
    RDB-->>PQ: Список сделок
    PQ-->>API: TradesDTO
    API-->>UI: 200 OK + TradesDTO

```

## 5) Автоматическая стратегия продажи при достижении цены
```mermaid
sequenceDiagram
    actor Trader as Трейдер
    participant UI as Клиент (Web/Mobile)
    participant API as API Gateway
    participant Auth as Auth Service
    participant SS as Strategy Service
    participant SDB as Strategy DB
    participant Bus as Event Bus (Kafka/AMQP)
    participant SE as Strategy Engine (Worker)
    participant OS as Order Service
    participant BG as Broker Gateway
    participant Broker as External Broker/Exchange

    Trader->>UI: Создать стратегию (SELL AAPL при price>=X)
    UI->>API: POST /strategies
    API->>Auth: Проверка прав
    Auth-->>API: OK
    API->>SS: CreateStrategy(cmd)
    SS->>SDB: Persist Strategy(status=ACTIVE)
    SDB-->>SS: OK
    SS->>Bus: Event StrategyActivated(strategyId, symbol, rule)

    note over SE: Engine подписан на QuoteUpdated и StrategyActivated
    Bus-->>SE: Deliver StrategyActivated
    loop Каждая новая котировка
        Bus-->>SE: QuoteUpdated(symbol, price)
        alt Условие выполнено (price>=X)
            SE->>OS: PlaceOrder(cmd SELL ...)
            OS->>Bus: Event OrderPlaced(orderId)
            Bus-->>BG: Consume OrderPlaced
            BG->>Broker: SubmitOrder(order)
            Broker-->>BG: ExecutionReport(FILL/REJECT)
            BG->>Bus: Event OrderExecutionReported(...)
        end
    end
```

## 6) Создание темы + модерация
```mermaid
sequenceDiagram
    actor User as Пользователь
    participant UI as Клиент (Web/Mobile)
    participant API as API Gateway
    participant Auth as Auth Service
    participant TS as Topic Service
    participant TDB as Topics DB
    participant MS as Moderation Service
    participant Bus as Event Bus
    participant NS as Notification Service

    User->>UI: Создать тему (title, body, tags)
    UI->>API: POST /topics
    API->>Auth: ValidateToken(JWT)
    Auth-->>API: OK
    API->>TS: CreateTopic(cmd)

    TS->>MS: CheckContent(title, body)
    alt Контент подозрительный
        MS-->>TS: FLAGGED
        TS->>TDB: Save(status=ON_REVIEW)
        TDB-->>TS: topicId
        TS-->>API: 202 Accepted (на модерации)
        API-->>UI: Тема отправлена на проверку
    else ОК
        MS-->>TS: OK
        TS->>TDB: Save(status=PUBLISHED)
        TDB-->>TS: topicId
        TS->>Bus: Event TopicCreated(topicId, authorId)
        Bus-->>NS: Deliver TopicCreated
        NS-->>UI: Push "Тема опубликована"
        TS-->>API: 201 Created (topicId)
        API-->>UI: Тема создана
    end
```

## 7) Создание рекомендации с привязкой инструмента
```mermaid
sequenceDiagram
    actor User as Пользователь
    participant UI as Клиент (Web/Mobile)
    participant API as API Gateway
    participant Auth as Auth Service
    participant RS as Recommendation Service
    participant MDS as Market Data Service
    participant RDB as Recommendations DB
    participant MS as Moderation Service
    participant Bus as Event Bus
    participant NS as Notification Service

    User->>UI: Создать рекомендацию (symbol, side, entry, target, stop, comment)
    UI->>API: POST /recommendations
    API->>Auth: ValidateToken(JWT)
    Auth-->>API: OK

    API->>RS: CreateRecommendation(cmd)
    RS->>MDS: GetLastQuote(symbol)
    MDS-->>RS: lastPrice, ts

    RS->>MS: CheckContent(comment)
    alt Контент подозрительный
        MS-->>RS: FLAGGED
        RS->>RDB: Save(status=ON_REVIEW, snapshotPrice=lastPrice)
        RDB-->>RS: recId
        RS-->>API: 202 Accepted (на модерации)
        API-->>UI: Рекомендация на проверке
    else ОК
        MS-->>RS: OK
        RS->>RDB: Save(status=PUBLISHED, snapshotPrice=lastPrice)
        RDB-->>RS: recId
        RS->>Bus: Event RecommendationCreated(recId, symbol, authorId)
        Bus-->>NS: Deliver RecommendationCreated
        NS-->>UI: Push "Рекомендация опубликована"
        RS-->>API: 201 Created (recId)
        API-->>UI: Рекомендация создана
    end

```